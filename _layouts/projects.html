---
layout: default
---
{% include sorted_projects.html %}

{% for project in sorted_projects %}
  {% assign tags = tags | concat: project.tags | uniq %}
{% endfor %}

{% assign filterable_tags = site.filterable_tags | sort: "position" %}
{% for filterable_tag in filterable_tags %}
  {% unless tags contains filterable_tag.title %}
    {% continue %}
  {% endunless %}
  {% comment %}
    The filter concat works only with array (at least that’s what
    Liquid documentation says). That is why filterable_tag cannot be
    used. So, we find the same tag again but keep it in array, so it
    can be concatenated.
  {% endcomment %}
  {% assign matching_tags = site.filterable_tags |
       where: "id", filterable_tag.id %}
  {% assign filtered_tags = filtered_tags | concat: matching_tags %}
{% endfor %}

<div id="content-row">
  <div class="row-container">
    <div class="container-fluid">
      {% include breadcrumb.html %}
      <div class="content-inner row-fluid">
        <!-- Left sidebar -->
        <div id="component" class="span8">

          <div class="page-blog page-blog__">
            <div class="page_header">
              <h3>
                <span class="item_title_part0">{{ page.title }}</span>
                {%- if page.subtitle -%}
                <br><small>{{ page.subtitle }}</small>
                {%- endif -%}
              </h3>
            </div>
            {{ content }}
          </div>
        </div>
        <!-- Right sidebar -->
        <div id="aside-right" class="span4">
          <aside>
            {% if filtered_tags and filtered_tags.size > 0 %}
            <div class="moduletable ">
              <h3 class="moduleTitle ">{{ site.data.projects.filter.by_tag }}</h3>
              <ul class="categories-module">
                <li id="filter_by_category_all" hidden>
                  <p>
                    <a href="{{ "/projects" | relative_url }}#">Zobrazit vše</a>
                    <br/>
                  </p>
                </li>

                {% for filtered_tag in filtered_tags %}
                  {% capture tag_slug -%}
                    {% include helpers/slug.html page=filtered_tag %}
                  {%- endcapture %}
                  <li>
                    <a href="{{ "/projects" | relative_url }}#category={{ tag_slug }}">
                      {{ filtered_tag.name }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if sorted_projects and sorted_projects.size > 0 %}
            <div class="moduletable ">
              <h3 class="moduleTitle ">{{ site.data.projects.filter.by_date }}</h3>

              <ul class="archive-module">
                <li id="filter_by_date_all" hidden>
                  <p>
                    <a href="{{ "/projects" | relative_url }}#">Zobrazit vše</a>
                    <br/>
                  </p>
                </li>

                {% assign oldest_project = sorted_projects |
                     where_exp: "project", "project.from != null" |
                     sort: "from" |
                     first %}
                {% assign first_date = oldest_project.from %}
                {% assign newest_project = sorted_projects |
                     where_exp: "project", "project.to != null" |
                     sort: "to" |
                     last %}
                {% assign last_date = newest_project.to %}
                <li>
                  <input type="month" name="date" min="{{ first_date }}" max="{{ last_date }}" class="js-date">
                </li>
              </ul>
            </div>
            {% endif %}
          </aside>
        </div>
      </div>
    </div>
  </div>
</div>

{% if sorted_projects and sorted_projects.size > 0 %}
<script>
  (function(w, d) {
    if (typeof [].forEach !== "function") return
    if (typeof [].map !== "function") return
    if (typeof [].reduce !== "function") return
    if (typeof [].every !== "function") return
    if (typeof Object.keys !== "function") return
    if (!("onpopstate" in w)) return

    function paramsFromHash(hash) {
      return !hash ? {} : hash.
        slice(1).
        split("&").
        map(function(rawPair) { return rawPair.split("=", 2) }).
        reduce(function(params, pair) {
          params[pair[0]] = pair.length === 2 ? pair[1] : true
          return params
        }, {})
    }

    function toggleShowAll(params) {
      d.getElementById("filter_by_category_all").hidden = !params["category"]
      d.getElementById("filter_by_date_all").hidden = !params["date"]
    }

    function ifFilterChanged(obj, cur, fn) {
      var pre = obj.params || {}
      var preKeys = Object.keys(pre).sort()
      var curKeys = Object.keys(cur).sort()
      var same = preKeys.length == curKeys.length &&
        preKeys.every(function(k, i) { return curKeys[i] === k })

      if (!same) fn()

      obj.params = cur
    }

    function toArray(indexable) {
      return Array.prototype.slice.call(indexable, 0)
    }

    function forEachProject(fn) {
      toArray(d.getElementsByClassName("js-project")).forEach(fn)
    }

    function noFilter() {
      forEachProject(function(p) { p.hidden = false })
    }

    function filterByCategory(filter) {
      if (!filter) return

      forEachProject(function(p) {
        p.hidden = toArray(
          p.getElementsByClassName("js-project-category")
        ).every(function(a) {
          var params = paramsFromHash("#" + a.href.split("#", 2)[1])
          return filter !== params["category"]
        })

        console.log("title", p.getElementsByTagName("H4")[0].textContent.
                               replace(/^\s+/, "").
                               replace(/\s+$/, ""))
        console.log("filter", filter)
        console.log("categories", toArray(
          p.getElementsByClassName("js-project-category")
        ).map(function(a) {
          return paramsFromHash("#" + a.href.split("#", 2)[1])["category"]
        }))
        console.log("hidden?", p.hidden)
      })
    }

    function resetTime(date) {
      var res = new Date(date)
      res.setHours(0)
      res.setMinutes(0)
      res.setSeconds(0)
      res.setMilliseconds(0)

      return res
    }

    function firstMomentOfMonth(month) {
      var parts = month.
        split("-", 3).
        map(function(p) { return p | 0 })

      date = new Date()
      date.setYear(parts[0])
      date.setMonth(parts[1] - 1)
      date.setDate(1)

      return resetTime(date)
    }

    function lastMomentOfMonth(month) {
      var date, day

      for (day = 29; day <= 32; day += 1) {
        date = new Date(firstMomentOfMonth(month))
        date.setDate(day)
        if (date.getMonth() !== firstMomentOfMonth(month).getMonth()) break
      }
      date.setTime(date.getTime() - 1)

      return date
    }

    function rangeFromDate(date) {
      switch (date.split("-").length) {
      case 1:
        return rangeFromYear(date)
      default:
        return rangeFromMonth(date)
      }
    }

    function rangeFromYear(date) {
      var range = {}
      range.from = firstMomentOfMonth(date + "-01")
      range.to = lastMomentOfMonth(date + "-12")

      return range
    }

    function rangeFromMonth(date) {
      var range = {}
      range.from = firstMomentOfMonth(date)
      range.to = lastMomentOfMonth(date)

      return range
    }

    function rangeFromMonths(from, to) {
      var range = {}

      range.from = from ?
        firstMomentOfMonth(from) :
        Number.NEGATIVE_INFINITY

      range.to = to ?
        lastMomentOfMonth(to) :
        Number.POSITIVE_INFINITY

      return range
    }

    function hasIntersection(a, b) {
      var st = a.from <= b.from ? a : b
      var nd = st === a ? b : a

      if (st.from < nd.from) {
        return st.to >= nd.from
      } else return true
    }

    function filterByDate(date) {
      if (!date) return

      var filter = rangeFromDate(date)
      forEachProject(function(p) {
        var fromEl = p.getElementsByClassName("js-project-from")[0]
        var toEl = p.getElementsByClassName("js-project-to")[0]
        var period = rangeFromMonths(
          fromEl && fromEl.getAttribute("datetime"),
          toEl && toEl.getAttribute("datetime")
        )

        p.hidden = !hasIntersection(filter, period)
      })
    }

    function filter(ev) {
      var params = paramsFromHash(ev.target.location.hash)
      ifFilterChanged(filter, params, noFilter)
      ensureDateFilterValue(params["date"])
      toggleShowAll(params)
      filterByCategory(params["category"])
      filterByDate(params["date"])
    }

    function pushDateFilter() {
      if (!readDateFilter()) return

      w.location = "#date=" + readDateFilter()
    }

    function ensureDateFilterValue(date) {
      var filterEl = d.getElementsByClassName("js-date")[0]
      if (filterEl.tagName === "INPUT") {
        filterEl.value = date
        return
      }

      var parts = (date || "").
        split("-", 3).
        map(function(p) { return p | 0 })

      var yearEl = filterEl.firstChild
      yearEl.value = parts[0] || ""

      var monthEl = filterEl.lastChild
      monthEl.value = parts[1] || ""
      monthEl.hidden = !yearEl.value
      monthEl.style.display = monthEl.hidden ? "none" : ""
    }

    function readDateFilter() {
      var filterEl = d.getElementsByClassName("js-date")[0]
      if (filterEl.tagName === "INPUT") return filterEl.value

      var yearEl = filterEl.firstChild
      var monthEl = filterEl.lastChild

      if (!yearEl.value) return yearEl.value

      var val = yearEl.value

      if (monthEl.value) val += "-"

      if (monthEl.value && monthEl.value.length < 2) val += "0" + monthEl.value
      else if (monthEl.value) val += monthEl.value

      return val
    }

    function initDateFilter() {
      var filterEl = d.getElementsByClassName("js-date")[0]
      if (filterEl.type === "month") return

      var containerEl = d.createElement("DIV")
      containerEl.className = "js-date"

      var yearEl = d.createElement("SELECT")
      yearEl.style.width = "auto"
      yearEl.appendChild(d.createElement("OPTION"))
      yearEl.childNodes[0].value = ""
      yearEl.childNodes[0].selected = true
      yearEl.childNodes[0].disabled = true
      yearEl.childNodes[0].textContent =
        "{{ site.data.projects.filter.year }}"

      var minYear = filterEl.getAttribute("min").slice(0, 4) | 0
      var maxYear = filterEl.getAttribute("max").slice(0, 4) | 0
      for (i = minYear; i <= maxYear; i += 1) {
        yearEl.appendChild(d.createElement("OPTION"))
        yearEl.childNodes[yearEl.childNodes.length - 1].textContent = i
      }

      var monthEl = d.createElement("SELECT")
      monthEl.hidden = true
      monthEl.style.display = monthEl.hidden ? "none" : ""
      monthEl.style.width = "auto"
      monthEl.appendChild(d.createElement("OPTION"))
      monthEl.childNodes[0].value = ""
      monthEl.childNodes[0].selected = true
      monthEl.childNodes[0].disabled = true
      monthEl.childNodes[0].textContent =
        "{{ site.data.projects.filter.month }}"

      var i;
      for (i = 1; i <= 12; i += 1) {
        monthEl.appendChild(d.createElement("OPTION"))
        monthEl.childNodes[monthEl.childNodes.length - 1].textContent = i
      }

      containerEl.appendChild(yearEl)
      containerEl.appendChild(monthEl)

      filterEl.parentNode.replaceChild(containerEl, filterEl)
    }

    w.addEventListener("popstate", filter, false)
    w.addEventListener("load", filter, false)
    d.addEventListener("DOMContentLoaded", function(ev) {
      w.removeEventListener("load", filter, false)
      filter(ev)
    }, false)
    initDateFilter()
    d.getElementsByClassName("js-date")[0].
      addEventListener("change", pushDateFilter, false)
  }(window, document))
</script>
{% endif %}
